# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy (code) to Azure Web App - findmyhome

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: 'production'
    env:
      AZURE_WEBAPP_NAME: findmyhome
      AZURE_RESOURCE_GROUP: azure-for-students

    steps:
    - uses: actions/checkout@v4

    - name: Package app for deployment
      run: |
        zip -r release.zip . \
          -x ".git/*" ".github/*" ".venv/*" "__pycache__/*" "*.pyc" \
          "notebook/*" "imgs/*" ".env"

    - name: Log in to Azure (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Deploy to Azure Web App (code)
      run: |
        az webapp deploy \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --name "$AZURE_WEBAPP_NAME" \
          --type zip \
          --src-path release.zip
